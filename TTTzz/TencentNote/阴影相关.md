# 角色阴影
iwiki:https://iwiki.woa.com/p/1432839755
为了保证美术效果，NPC的阴影效果是根据当前Mesh整体是否处于阴影内来判断并实现的，而非直接采样ShadowMap
NRC里做法类似原神，并在其基础上做了点优化
## 具体流程
1. 收集NPC位置信息，并在其附近生成一些Sensor，NPC位置收集功能由挂载在其身上的CustomShadowComponent负责（<font color=red>这部分TA有提到过阴影的判断由BP中挂载Component改为NPC Material自身负责，因为有些场景中可能会直接放一个SkeletonMesh，而由于其没有挂载Compoennt所以没有阴影效果，虽然我觉得这是制作流程不规范导致的，但是由每个Material实例来判断自己是否处于阴影显然是更合理的，可以改成检测每个NPC Material Instance的生成然后根据其Mesh信息生成Sensor</font>），同时生成NPC对应到ShadowTexture上的UV
2. 通过将Sensor的位置依次Reproject到每级Casade ShadowMap上检测其光源遮挡性来检测Sensor遮挡性，如果多数Sensor是被遮挡的则认为NPC处于阴影中，将遮挡信息最终记录在ShadowTexture中
3. NPC渲染时根据自己对应的UV去采样这张图
## 好像偶尔会出现的一个小问题
角色的阴影会出现闪烁，即使ShadowMap和NPC的位置不变，这个问题只在PC上会出现，之前IOS也遇到了，但IOS上是因为用ComputeShader计算生成ShadowTexture然后PixelShader里用这个过程没有做同步，导致PixelShader里采样一个还没准备好的Texture，PC上这个表现上有点类似当时IOS上的问题，解决方式可以尝试把ComputeShader换成PixelShader实现，这个在多平台上应该都不会有同步问题
# Cascade Shadow
## 分帧更新
commit：7057384b8d7ec764ef454e19ceb5852e5cd31dea
以及后续CSM分帧更新相关
目前Cascade Shadow可以分帧更数级（1~MAX），未被更新的Cascade会沿用上一帧的数据，这个功能目前看来挺稳定的，<font color=red>后续小概率会遇到一个问题，当场景中使用了多张Cascade Shadow Map时候可能会产生阴影错位的效果（比如多窗口视角，每个窗口中都需要显示阴影），这个是因为每帧Shadow Pass都会申请一张固定格式名称的RT，而RT Pool中如果存在一张符合要求且无引用的RT时会返回这张RT，如果场景中只有一个方向光则每帧使用的是一张RT，在这种情况下分帧更新是没有问题的（也确认过NRC中只会有一个方向光），但如果这张图被在Shadow Pass外的Pass修改，则会出现阴影显示不正确的问题（之前在Editor下就会出现资源缩略图中的Shadow和Game View下的Shadow阴影错位的问题，这是因为两个View使用的是同一张RT），修复的方法也很简单，为每个方向光Cache住它使用的RT，其余方向光/View的ShadowMap重新申请即可</font>